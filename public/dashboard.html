<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hot Wheels Collection | Premium Diecast Cars</title>
  <meta name="description" content="Browse our exclusive collection of Hot Wheels diecast cars. Find rare models, limited editions, and classic favorites.">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Oswald:wght@500;600;700&display=swap" rel="stylesheet">

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<style>
    :root {
      --primary: #e51937;
      --secondary: #1a1a1a;
      --accent: #ffc72c;
      --light-gray: #f8f9fa;
      --dark-gray: #343a40;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      color: var(--secondary);
      background-color: #f5f5f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Oswald', sans-serif;
      font-weight: 600;
    }
    
    .hero-banner {
      height: 100vh;
      background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), 
                  url('../images/headertest.jpg') no-repeat center center;
      background-size: cover;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-bottom: 2rem;
      position: relative;
    }
    
    .hero-title {
      font-size: 4rem;
      text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
      letter-spacing: 2px;
      margin-bottom: 1rem;
    }
    
    .hero-subtitle {
      font-size: 1.5rem;
      text-shadow: 1px 1px 4px rgba(0,0,0,0.6);
      max-width: 800px;
      margin: 0 auto;
    }
    
    .section-title {
      position: relative;
      margin-bottom: 2rem;
      text-align: center;
    }
    
    .section-title:after {
      content: "";
      display: block;
      width: 80px;
      height: 4px;
      background: var(--primary);
      margin: 10px auto;
    }
    
    #productGrid {
      margin: 0 -15px;
    }
    
    .product-card {
      transition: all 0.3s ease;
      border: none;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      background: white;
      height: 100%;
    }
    
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }
    
    .product-card img {
      height: 220px;
      object-fit: contain;
      padding: 20px;
      background: var(--light-gray);
    }
    
    .product-card .card-body {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }
    
    .product-card .card-title {
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: 0.75rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .product-card .price {
      color: var(--primary);
      font-weight: 700;
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }
    
    .product-card .stock {
      color: #28a745;
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    .product-card .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
      font-weight: 500;
      width: 100%;
    }
    
    .product-card .btn-outline-secondary {
      width: 100%;
      margin-top: 10px;
    }
    
    .product-card .btn-container {
      margin-top: auto;
      padding-top: 15px;
    }
    
    .category-btn {
      border-radius: 20px;
      padding: 8px 20px;
      margin: 0 5px 10px 0;
      font-weight: 500;
      transition: all 0.3s;
      border: 2px solid var(--primary);
    }
    
    .category-btn.active {
      background-color: var(--primary);
      color: white;
    }
    
    .category-btn:not(.active) {
      color: var(--primary);
      background-color: transparent;
    }
    
    .category-btn:hover:not(.active) {
      background-color: rgba(229, 25, 55, 0.1);
    }
    
    .search-box {
      max-width: 400px;
      border-radius: 30px;
      border: 2px solid #ddd;
      padding-left: 20px;
    }
    
    .search-btn {
      border-radius: 0 30px 30px 0;
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 0 20px;
    }
    
    .filter-container {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
    }
    
    .modal-header {
      border-bottom: none;
      padding-bottom: 0;
    }
    
    .modal-title {
      color: var(--primary);
      font-weight: 700;
    }
    
    .modal-content {
      border-radius: 10px;
      border: none;
    }
    
    #modalItemPrice {
      color: var(--primary);
      font-weight: 700;
      font-size: 1.5rem;
    }
    
    #modalAddToCart {
      background-color: var(--primary);
      border-color: var(--primary);
      font-weight: 500;
      padding: 10px 25px;
      border-radius: 30px;
    }
    
    .review-item {
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
      margin-bottom: 15px;
    }
    
    .review-item:last-child {
      border-bottom: none;
    }
    
    .rating {
      color: var(--accent);
      margin-bottom: 5px;
    }
    
    .review-author {
      font-weight: 500;
    }
    
    .review-date {
      color: #6c757d;
      font-size: 0.85rem;
    }
    
    .loading-spinner {
      display: none;
      text-align: center;
      padding: 30px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0,0,0,0.1);
      border-left-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .cart-count-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--accent);
      color: var(--secondary);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    
    /* Improved product container spacing */
    .product-container {
      padding: 15px;
    }
    
    /* Responsive adjustments */
    @media (max-width: 992px) {
      .product-card {
        margin-bottom: 25px;
      }
    }
    
    @media (max-width: 768px) {
      .hero-title {
        font-size: 2.5rem;
      }
      
      .product-card {
        margin-bottom: 20px;
      }
      
      .product-card img {
        height: 180px;
        padding: 15px;
      }
      
      .filter-container {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div id="header"></div>

  <!-- Page Content -->
  <main class="container-fluid px-0">
    <!-- Hero Banner -->
    <div class="hero-banner">
      <div class="container text-center">
        <h1 class="hero-title">HOT WHEELS COLLECTION</h1>
        <p class="hero-subtitle">Premium Diecast Cars for Collectors & Enthusiasts</p>
      </div>
    </div>

    <div class="container">
      <h2 class="section-title">EXPLORE OUR COLLECTION</h2>

      <!-- Filter & Search -->
      <div class="filter-container">
        <div class="row align-items-center">
          <div class="col-md-8 mb-3 mb-md-0">
            <div id="categoryButtons" class="d-flex flex-wrap">
              <button class="btn category-btn active" data-id="">All Products</button>
            </div>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <input type="text" id="searchInput" class="form-control search-box" placeholder="Search models...">
              <button class="btn search-btn" id="searchBtn">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading Spinner -->
      <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
        <p class="mt-2">Loading products...</p>
      </div>

      <!-- Product Grid -->
      <div class="row" id="productGrid"></div>

      <!-- Empty State -->
      <div class="text-center py-5" id="emptyState" style="display: none;">
        <i class="fas fa-car fa-3x mb-3" style="color: #ddd;"></i>
        <h4>No Products Found</h4>
        <p class="text-muted">Try adjusting your search or filter criteria</p>
        <button class="btn btn-outline-primary" id="resetFilters">Reset Filters</button>
      </div>
    </div>
  </main>

  <!-- Product Detail Modal -->
  <div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="productDetailLabel">Product Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6" id="modalImages">
              <div class="placeholder-glow" style="height: 300px; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <h3 id="modalItemName" class="mb-3">Loading...</h3>
              <div class="d-flex align-items-center mb-2">
                <span class="price-label me-2"><strong>Price:</strong></span>
                <span class="price-value" id="modalItemPrice">₱0.00</span>
              </div>
              <div class="d-flex align-items-center mb-3">
                <span class="stock-label me-2"><strong>Availability:</strong></span>
                <span class="stock-value badge bg-success" id="modalItemStock">In Stock</span>
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-primary mt-3" id="modalAddToCart">
                  <i class="fas fa-cart-plus me-2"></i>Add to Cart
                </button>
              </div>
            </div>
          </div>
          
          <hr class="my-4">
          
          <div class="product-description mb-4">
            <h5><i class="fas fa-info-circle me-2"></i>Description</h5>
            <p id="modalItemDescription" class="text-muted">Product description loading...</p>
          </div>
          
          <div class="product-reviews">
            <h5><i class="fas fa-star me-2"></i>Customer Reviews</h5>
            <div id="modalReviews">
              <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading reviews...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- Footer Container -->
  <div id="footer-container"></div>

 <script>
  function parseImages(imageField) {
    if (!imageField) return [];
    if (Array.isArray(imageField)) return imageField;

    try {
      const parsed = JSON.parse(imageField);
      return Array.isArray(parsed) ? parsed : [imageField];
    } catch (e) {
      if (typeof imageField === 'string') {
        return imageField.split(',').map(s => s.trim());
      }
      return [imageField];
    }
  }

  function loadItems(categoryId = '', keyword = '') {
    $('#loadingSpinner').show();
    $('#productGrid').hide();
    $('#emptyState').hide();
    
    let url = '/api/item';
    if (categoryId && keyword) {
      url = `/api/item/category/${categoryId}?search=${encodeURIComponent(keyword)}`;
    } else if (categoryId) {
      url = `/api/item/category/${categoryId}`;
    } else if (keyword) {
      url = `/api/item/search/${encodeURIComponent(keyword)}`;
    }

    $.get(url, function (res) {
      if (res.status === 'success' || res.success) {
        let html = '';
        const items = res.data || res.items || [];
        
        if (items.length === 0) {
          $('#emptyState').show();
        } else {
          items.forEach(item => {
            let images = parseImages(item.images);
            images = [...new Set(images)];

            const uniqueCarouselId = `carousel-${item.item_id}`;
            let imageHtml = '';

            if (images.length === 1) {
              imageHtml = `<img src="/uploads/${images[0]}" class="card-img-top img-fluid" onerror="this.style.display='none';">`;
            } else if (images.length > 1) {
              imageHtml = `
                <div id="${uniqueCarouselId}" class="carousel slide" data-bs-ride="carousel">
                  <div class="carousel-inner">
                    ${images.map((img, idx) => `
                      <div class="carousel-item ${idx === 0 ? 'active' : ''}">
                        <img src="/uploads/${img}" class="d-block w-100" onerror="this.style.display='none';">
                      </div>
                    `).join('')}
                  </div>
                  <button class="carousel-control-prev" type="button" data-bs-target="#${uniqueCarouselId}" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  </button>
                  <button class="carousel-control-next" type="button" data-bs-target="#${uniqueCarouselId}" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  </button>
                </div>`;
            }

            html += `
              <div class="col-lg-3 col-md-4 col-sm-6 product-container">
                <div class="card product-card h-100">
                  ${imageHtml}
                  <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${item.item_name}</h5>
                    <div class="price mb-2">₱${parseFloat(item.sell_price).toFixed(2)}</div>
                   <div class="stock mb-3 ${item.stock > 0 ? 'text-success' : 'text-danger'}">
                     ${item.stock} available
                    </div>
                    <div class="mt-auto">
                      <button class="btn btn-primary add-to-cart-btn ${item.stock <= 0 ? 'disabled' : ''}"
                        data-id="${item.item_id}" data-name="${item.item_name}" data-price="${item.sell_price}">
                        <i class="fas fa-cart-plus me-1"></i> Add to Cart
                      </button>
                      <button class="btn btn-outline-secondary mt-2 see-details-btn" data-id="${item.item_id}">
                        <i class="fas fa-eye me-1"></i> View Details
                      </button>
                    </div>
                  </div>
                </div>
              </div>`;
          });
        }
        
        $('#productGrid').html(html).fadeIn();
      } else {
        $('#emptyState').show();
      }
    }).fail(() => {
      $('#emptyState').show();
    }).always(() => {
      $('#loadingSpinner').hide();
    });
  }

  function loadCategories(selectedCategory = '') {
    $.get('/api/category', function (res) {
      if ((res.success || res.status === 'success') && Array.isArray(res.data)) {
        const $container = $('#categoryButtons');
        $container.html(`
          <button class="btn category-btn ${selectedCategory === '' ? 'active' : ''}" data-id="">All Products</button>
        `);
        res.data.forEach(cat => {
          const isActive = selectedCategory === cat.category_id ? 'active' : '';
          $container.append(`
            <button class="btn category-btn ${isActive}" data-id="${cat.category_id}">
              ${cat.description}
            </button>
          `);
        });
      }
    });
  }

  function updateCartCount() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    $('#cart-count').text(cart.reduce((total, item) => total + item.quantity, 0));
  }

  $(document).ready(function () {
    $('#header').load('/header.html', function () {
      const dropdownTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="dropdown"]'));
      dropdownTriggerList.map(function (dropdownTriggerEl) {
        new bootstrap.Dropdown(dropdownTriggerEl);
      });

      const token = localStorage.getItem('token');
      const userId = localStorage.getItem('userId');

      if (token && userId) {
        $('#login-link, #register-link').addClass('d-none');
        $('#user-dropdown').removeClass('d-none');

        $.get(`/api/users/customers/${userId}`, function (res) {
          if (res.success && res.data) {
            const data = res.data;
            const fullName = `${data.fname || ''} ${data.lname || ''}`.trim();
            $('#username').text(fullName || 'USER');
            if (data.image_path) {
              $('.profile-img').attr('src', `/${data.image_path}`);
            }
          }
        });
      }

      updateCartCount();
    });

    loadItems();
    loadCategories();

    $(document).on('click', '.category-btn', function () {
      $('.category-btn').removeClass('active');
      $(this).addClass('active');
      const categoryId = $(this).data('id');
      const keyword = $('#searchInput').val().trim();
      loadItems(categoryId, keyword);
    });

    $('#searchBtn').on('click', function () {
      const keyword = $('#searchInput').val().trim();
      const activeCategory = $('.category-btn.active').data('id') || '';
      loadItems(activeCategory, keyword);
    });
    
    $('#searchInput').on('keypress', function(e) {
      if (e.which === 13) {
        $('#searchBtn').click();
      }
    });

    $('#resetFilters').on('click', function() {
      $('.category-btn').removeClass('active');
      $('.category-btn[data-id=""]').addClass('active');
      $('#searchInput').val('');
      loadItems();
    });

    $(document).on('click', '.add-to-cart-btn', function () {
      const token = localStorage.getItem('token');
      const userId = localStorage.getItem('userId');

      if (!token || !userId) {
        alert('You must be logged in first!');
        window.location.href = '/login.html';
        return;
      }

      const card = $(this).closest('.product-card');
      const imagePath = card.find('img').first().attr('src')?.replace('/uploads/', '') || 'default.jpg';

      const product = {
        id: $(this).data('id'),
        name: $(this).data('name'),
        price: $(this).data('price'),
        image_path: imagePath,
        quantity: 1
      };

      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      const existingItem = cart.find(item => item.id === product.id);
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push(product);
      }

      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartCount();
      
      const toast = `
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
          <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-primary text-white">
              <strong class="me-auto">Added to Cart</strong>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
              ${product.name} has been added to your cart.
            </div>
          </div>
        </div>
      `;
      
      $('body').append(toast);
      setTimeout(() => {
        $('.toast').remove();
      }, 3000);
    });

    let currentModalItem = null;
    
    $(document).on('click', '.see-details-btn', function () {
      const itemId = $(this).data('id');
      
      const card = $(this).closest('.product-card');
      currentModalItem = {
          id: itemId,
          name: card.find('.card-title').text(),
          price: parseFloat(card.find('.price').first().text().replace('₱', '')),
          image_path: card.find('img').first().attr('src')?.replace('/uploads/', '') || 'default.jpg',
          stock: card.find('.stock').text().includes('In Stock') ? 1 : 0
      };

      $.get(`/api/item/${itemId}`, function (res) {
          if (res.success && res.result && res.result.length > 0) {
              const item = res.result[0];
              
              $('#modalItemName').text(item.item_name || 'No name available');
              $('#modalItemPrice').text(parseFloat(item.sell_price || 0).toFixed(2));
              $('#modalItemStock').text(`${item.quantity} available`);
              $('#modalItemStock').removeClass('bg-success bg-danger')
            .addClass(item.quantity > 0 ? 'bg-success' : 'bg-danger');
              
              $('#modalItemDescription').text(item.description || 'No description available.');

              const allImages = item.all_images || [];
              
              let imgHtml = '';
              if (allImages.length > 0) {
                  imgHtml = `
                  <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                      <div class="carousel-inner">
                          ${allImages.map((img, index) => `
                              <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                  <img src="/uploads/${img}" 
                                      class="d-block w-100"
                                      style="height: 300px; object-fit: contain;"
                                      onerror="this.style.display='none';">
                              </div>
                          `).join('')}
                      </div>
                      <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                      </button>
                      <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                          <span class="carousel-control-next-icon" aria-hidden="true"></span>
                      </button>
                  </div>`;
              } else {
                  imgHtml = `
                  <div style="height: 300px; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                    <i class="fas fa-car fa-3x text-muted"></i>
                  </div>`;
              }
              $('#modalImages').html(imgHtml);
              
              $('#modalAddToCart').toggleClass('disabled', item.quantity <= 0);
          } else {
              $('#modalImages').html('<p class="text-center py-5 text-muted">Failed to load product details</p>');
          }
      }).fail(function() {
          $('#modalImages').html('<p class="text-center py-5 text-muted">Error loading product details</p>');
      });

      $.get(`/api/reviews/item/${itemId}`, function (res) {
          if ((res.success || res.status === 'success') && Array.isArray(res.data)) {
              if (res.data.length === 0) {
                  $('#modalReviews').html(`
                    <div class="text-center py-4">
                      <i class="fas fa-comment-slash fa-2x text-muted mb-2"></i>
                      <p class="text-muted">No reviews yet. Be the first to review!</p>
                    </div>
                  `);
                  return;
              }

              const reviewHtml = res.data.map(r => {
                  const customerName = (r.fname && r.lname) ? `${r.fname} ${r.lname}` : 'Anonymous';
                  return `
                      <div class="review-item">
                          <div class="d-flex justify-content-between align-items-center mb-2">
                              <div>
                                  <span class="review-author">${customerName}</span>
                                  <span class="review-date ms-2">${new Date(r.created_at).toLocaleDateString()}</span>
                              </div>
                              <div class="rating">
                                  ${'<i class="fas fa-star"></i>'.repeat(r.rating)}${'<i class="far fa-star"></i>'.repeat(5 - r.rating)}
                              </div>
                          </div>
                          <p>${r.review_text || 'No review text provided.'}</p>
                      </div>
                  `;
              }).join('');

              $('#modalReviews').html(reviewHtml);
          }
      });

      const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
      modal.show();
    });

    $('#modalAddToCart').on('click', function() {
      if (!currentModalItem || $(this).hasClass('disabled')) return;
      
      const token = localStorage.getItem('token');
      const userId = localStorage.getItem('userId');

      if (!token || !userId) {
        alert('You must be logged in first!');
        window.location.href = '/login.html';
        return;
      }

      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      const existingItem = cart.find(item => item.id === currentModalItem.id);
      
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        currentModalItem.quantity = 1;
        cart.push(currentModalItem);
      }

      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartCount();
      
      const toast = `
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
          <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-primary text-white">
              <strong class="me-auto">Added to Cart</strong>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
              ${currentModalItem.name} has been added to your cart.
            </div>
          </div>
        </div>
      `;
      
      $('body').append(toast);
      setTimeout(() => {
        $('.toast').remove();
      }, 3000);
    });
    
    // Load footer
    $('#footer-container').load('/footer.html', function(response, status, xhr) {
      if (status == "error") {
        console.log("Error loading footer: " + xhr.status + " " + xhr.statusText);
      }
    });
  });
</script>
</body>
</html>